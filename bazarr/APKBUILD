pkgname=bazarr
pkgver=1.5.2
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
  python3
  ffmpeg
  p7zip
"

makedepends="
  build-base
  python3-dev
  py3-pip
  py3-wheel
  py3-setuptools
  unzip
  cargo
  lapack-dev
  libxml2-dev
  libxslt-dev
"
options="!check"

# System account that will own /var/lib/bazarr
pkgusers="bazarr"
pkggroups="bazarr"
install="$pkgname.pre-install $pkgname.post-upgrade"
subpackages="$pkgname-openrc"

# Upstream ships a ready-to-run zip archive named bazarr.zip
source="
  $pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
"
builddir="$srcdir"

build() {
  cd "$builddir"
  python3 -m pip install \
    --no-user \
    --target=./libs \
    -r requirements.txt
}

package() {
  install -d "$pkgdir"/usr/lib/$pkgname
  cp -r "$builddir"/* "$pkgdir"/usr/lib/$pkgname/

  install -d "$pkgdir"/usr/bin
  cat >"$pkgdir"/usr/bin/bazarr <<'EOF'
#!/bin/sh
export PYTHONPATH="/usr/lib/bazarr/libs"
exec python3 /usr/lib/bazarr/bazarr.py --no-update "$@"
EOF
  chmod +x "$pkgdir"/usr/bin/bazarr

  install -Dm755 "$srcdir"/bazarr.initd "$pkgdir"/etc/init.d/bazarr
  install -Dm644 "$srcdir"/bazarr.confd "$pkgdir"/etc/conf.d/bazarr

  # Data directory
  install -d -o bazarr -g bazarr -m 755 "$pkgdir"/var/lib/bazarr
}

sha512sums="
524a8818e7da415bc5bd0e73955e8638750ad2c760c73473d9e7423fe3c0d84a078dddc0f57c1f48a884a83ff9e1dce7a1e6b76cc21a31e03caa669f2f6e986b  bazarr-1.5.2.zip
62eef4e66064767bacdc7e98dff9f5e0f9e496eabd72926fcfaf665943db280d055a83f4506d04957c45285ec9b879a8f2cf026242d9a86180657cbdb8656e62  bazarr.initd
4089aface13f34c24fa57ba1cb339c26ba62affd736c7705e70ab674a661b19c309b2c55e937d1925a3285211bd5a5f99c7348323fe780b2a3b836ecf4623f99  bazarr.confd
"
