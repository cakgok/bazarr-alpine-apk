pkgname=bazarr
pkgver=1.5.3
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
  python3
  ffmpeg
  p7zip
"

makedepends="
  build-base
  python3-dev
  py3-pip
  py3-wheel
  py3-setuptools
  unzip
  cargo
  lapack-dev
  libxml2-dev
  libxslt-dev
"
options="!check"

pkgusers="bazarr"
pkggroups="bazarr"
install="$pkgname.pre-install $pkgname.post-upgrade"
subpackages="$pkgname-openrc::x86_64"

source="
  $pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
"
builddir="$srcdir"

build() {
  cd "$builddir"
  python3 -m pip install \
    --no-user \
    --target=./libs \
    -r requirements.txt
}

package() {
  install -d "$pkgdir"/usr/lib/$pkgname
  cp -r "$builddir"/* "$pkgdir"/usr/lib/$pkgname/

  install -d "$pkgdir"/usr/bin
  cat >"$pkgdir"/usr/bin/bazarr <<'EOF'
#!/bin/sh
export PYTHONPATH="/usr/lib/bazarr/libs"
exec python3 /usr/lib/bazarr/bazarr.py --no-update "$@"
EOF
  chmod +x "$pkgdir"/usr/bin/bazarr

  cat >"$pkgdir"/usr/bin/unrar <<'EOF'
#!/bin/sh
# lightweight shim so software expecting "unrar" works with p7zip
exec /usr/bin/7z x -y "$@"
EOF
   chmod +x "$pkgdir"/usr/bin/unrar

  install -Dm755 "$srcdir"/bazarr.initd "$pkgdir"/etc/init.d/bazarr
  install -Dm644 "$srcdir"/bazarr.confd "$pkgdir"/etc/conf.d/bazarr

  # Data directory
  install -d -o bazarr -g bazarr -m 755 "$pkgdir"/var/lib/bazarr
}

sha512sums="
7ec1366a94a26722b5b4bb17d33600a3f96379bbaad9a4a0337a98be11d9f5ed95b635be1bee2eee3c4e4455ca3d02497018f4579074ec91163836af2db42dbd  bazarr-1.5.3.zip
db7cc7e12ffc783a3b905ea12b4bd11006490f02f163de7bf3fb2a506677e459940a60fb0ffc9fd4a57692f51df5b3b0ff3497363aea514bfd5247473b201a25  bazarr.initd
799aa65c4913206c60b86b0ba9f3424e21205b0f7ecf2e3ad2dde517a724bf7a0ad000c91cf86aa028eea95d13667b2cdcda6a81a8f830ecb9d5faf46c7d8879  bazarr.confd
"
