pkgname=bazarr
pkgver=1.5.2
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
  python3
  ffmpeg
  p7zip
"

makedepends="
  build-base
  python3-dev
  py3-pip
  py3-wheel
  py3-setuptools
  unzip
  cargo
  lapack-dev
  libxml2-dev
  libxslt-dev
"
options="!check"

pkgusers="bazarr"
pkggroups="bazarr"
install="$pkgname.pre-install $pkgname.post-upgrade"
subpackages="$pkgname-openrc"

source="
  $pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
"
builddir="$srcdir"

build() {
  cd "$builddir"
  python3 -m pip install \
    --no-user \
    --target=./libs \
    -r requirements.txt
}

package() {
  install -d "$pkgdir"/usr/lib/$pkgname
  cp -r "$builddir"/* "$pkgdir"/usr/lib/$pkgname/

  install -d "$pkgdir"/usr/bin
  cat >"$pkgdir"/usr/bin/bazarr <<'EOF'
#!/bin/sh
export PYTHONPATH="/usr/lib/bazarr/libs"
exec python3 /usr/lib/bazarr/bazarr.py --no-update "$@"
EOF
  chmod +x "$pkgdir"/usr/bin/bazarr

  cat >"$pkgdir"/usr/bin/unrar <<'EOF'
#!/bin/sh
# lightweight shim so software expecting "unrar" works with p7zip
exec /usr/bin/7z x -y "$@"
EOF
   chmod +x "$pkgdir"/usr/bin/unrar

  install -Dm755 "$srcdir"/bazarr.initd "$pkgdir"/etc/init.d/bazarr
  install -Dm644 "$srcdir"/bazarr.confd "$pkgdir"/etc/conf.d/bazarr

  # Data directory
  install -d -o bazarr -g bazarr -m 755 "$pkgdir"/var/lib/bazarr
}

sha512sums="
524a8818e7da415bc5bd0e73955e8638750ad2c760c73473d9e7423fe3c0d84a078dddc0f57c1f48a884a83ff9e1dce7a1e6b76cc21a31e03caa669f2f6e986b  bazarr-1.5.2.zip
67867536cc2649cf848050329e2b01b0d1f0f2c0aa8f7b770664a3e125a903bf3623be0c0284ea74e9ff4d5f2eeeb4da8a667677b3541407a4d16ad441f7faa2  bazarr.initd
799aa65c4913206c60b86b0ba9f3424e21205b0f7ecf2e3ad2dde517a724bf7a0ad000c91cf86aa028eea95d13667b2cdcda6a81a8f830ecb9d5faf46c7d8879  bazarr.confd
"
