pkgname=bazarr
pkgver=1.5.2
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
  python3
  ffmpeg
  p7zip
  unarchiver
"

makedepends="
  build-base
  python3-dev
  py3-pip
  py3-wheel
  py3-setuptools
  unzip
  cargo
  lapack-dev
  libxml2-dev
  libxslt-dev
"
options="!check"

# System account that will own /var/lib/bazarr
pkgusers="bazarr"
pkggroups="bazarr"

# Scriptlets (NOT listed in source=)
install="$pkgname.pre-install $pkgname.post-upgrade"


# Upstream ships a ready-to-run zip archive named bazarr.zip
source="
  $pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
"
builddir="$srcdir"

build() {
  cd "$builddir"
  python3 -m pip install \
    --no-user \
    --target=./libs \
    -r requirements.txt
}

package() {
  install -d "$pkgdir"/opt/bazarr
  cp -r "$builddir"/* "$pkgdir"/opt/bazarr/

  install -d "$pkgdir"/usr/bin
  cat >"$pkgdir"/usr/bin/bazarr <<'EOF'
#!/bin/sh
export PYTHONPATH="/opt/bazarr/libs"
exec python3 /opt/bazarr/bazarr.py --no-update "$@"
EOF
  chmod +x "$pkgdir"/usr/bin/bazarr

  # OpenRC service
  install -Dm755 "$srcdir"/bazarr.initd "$pkgdir"/etc/init.d/bazarr
  install -Dm644 "$srcdir"/bazarr.confd "$pkgdir"/etc/conf.d/bazarr

  # Data directory
  install -d -o bazarr -g bazarr -m 755 "$pkgdir"/var/lib/bazarr
}
