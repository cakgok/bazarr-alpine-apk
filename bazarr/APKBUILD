pkgname=bazarr
pkgver=1.5.2
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
  python3
  ffmpeg
  p7zip
  unrar
"
makedepends="
    build-base
    python3-dev
    py3-pip
    py3-wheel
    py3-setuptools
    unzip
    libxml2-dev
    libxslt-dev
    cargo
"
options="!check"

# Upstream always ships a ready-to-run zip archive named bazarr.zip
source="$pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip"
builddir="$srcdir/$pkgname"

build() {
    cd "$srcdir"
    python3 -m pip install \
        --no-user \
        --target=./libs \
        -r requirements.txt
}

package() {
    # Install the main application files
    install -d "$pkgdir"/opt/bazarr
    cp -r "$srcdir"/* "$pkgdir"/opt/bazarr/

    # Clean up build-only files from the final package
    rm -rf "$pkgdir"/opt/bazarr/libs # Remove the empty placeholder libs dir

    # Install the vendored python libraries from the build stage
    install -d "$pkgdir"/opt/bazarr/libs
    cp -r "$builddir"/libs/* "$pkgdir"/opt/bazarr/libs/

    # Create a wrapper script in /usr/bin for easy execution
    install -d "$pkgdir"/usr/bin
    cat > "$pkgdir"/usr/bin/bazarr <<-EOF
#!/bin/sh
export PYTHONPATH="/opt/bazarr/libs"

# Run the main application from its location in /opt.
# The --no-update flag prevents Bazarr from breaking the package manager's control.
# "\$@" passes all command-line arguments to the script.
exec python3 /opt/bazarr/bazarr.py --no-update "\$@"
EOF
    chmod +x "$pkgdir"/usr/bin/bazarr

    # Install OpenRC service files
    install -d "$pkgdir"/etc/init.d
    install -Dm755 "$startdir"/bazarr.initd "$pkgdir"/etc/init.d/bazarr

    install -d "$pkgdir"/etc/conf.d
    install -Dm644 "$startdir"/bazarr.confd "$pkgdir"/etc/conf.d/bazarr
}

sha512sums="
524a8818e7da415bc5bd0e73955e8638750ad2c760c73473d9e7423fe3c0d84a078dddc0f57c1f48a884a83ff9e1dce7a1e6b76cc21a31e03caa669f2f6e986b  bazarr-1.5.2.zip
"
