pkgname=bazarr
pkgver=1.5.2
pkgrel=0
pkgdesc="Bazarr â€“ companion app for Sonarr/Radarr that fetches subtitles"
url="https://bazarr.media"
arch="x86_64"
license="GPL-3.0-or-later"

depends="
  python3
  ffmpeg
  p7zip
"

makedepends="
  build-base
  python3-dev
  py3-pip
  py3-wheel
  py3-setuptools
  unzip
  cargo
  lapack-dev
  libxml2-dev
  libxslt-dev
"
options="!check"

# System account that will own /var/lib/bazarr
pkgusers="bazarr"
pkggroups="bazarr"
install="$pkgname.pre-install $pkgname.post-upgrade"
subpackages="$pkgname-openrc"

# Upstream ships a ready-to-run zip archive named bazarr.zip
source="
  $pkgname-$pkgver.zip::https://github.com/morpheus65535/bazarr/releases/download/v$pkgver/bazarr.zip
  bazarr.initd
  bazarr.confd
"
builddir="$srcdir"

build() {
  cd "$builddir"
  python3 -m pip install \
    --no-user \
    --target=./libs \
    -r requirements.txt
}

package() {
  install -d "$pkgdir"/usr/lib/$pkgname
  cp -r "$builddir"/* "$pkgdir"/usr/lib/$pkgname/

  install -d "$pkgdir"/usr/bin
  cat >"$pkgdir"/usr/bin/bazarr <<'EOF'
#!/bin/sh
export PYTHONPATH="/usr/lib/bazarr/libs"
exec python3 /usr/lib/bazarr/bazarr.py --no-update "$@"
EOF
  chmod +x "$pkgdir"/usr/bin/bazarr

  install -Dm755 "$srcdir"/bazarr.initd "$pkgdir"/etc/init.d/bazarr
  install -Dm644 "$srcdir"/bazarr.confd "$pkgdir"/etc/conf.d/bazarr

  # Data directory
  install -d -o bazarr -g bazarr -m 755 "$pkgdir"/var/lib/bazarr
}

sha512sums="
524a8818e7da415bc5bd0e73955e8638750ad2c760c73473d9e7423fe3c0d84a078dddc0f57c1f48a884a83ff9e1dce7a1e6b76cc21a31e03caa669f2f6e986b  bazarr-1.5.2.zip
e17202772239defa34dccb275956ff661249095dff743799349916fdb90778236b1a9ad1b4d90150739b9a31ad39db570250b914374956253b84853cfcb88cc8  bazarr.initd
2719aa1ce1397f995cf1afdbc61e76ddc0abe5ec1f80d9a895a6c3e79264fd9a3c640eee273326dab8a1347f309231822131ca4afc2fd1fcdcba1623e0cfedba  bazarr.confd
"
